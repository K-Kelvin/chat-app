{% extends "base.html" %} 
{% load static custom_tags %} 

{% block head %}
<script src="{% static 'checkProfanity.js' %}"></script>
<script src="{% static 'moment.js' %}" defer></script>
<script src="{% static 'helpers.js' %}" defer></script>
{% endblock head %} 

{% block body %}
<section style="background-color: var(--primary-color); height: 100%">
	<div class="container" style="margin-bottom: 1rem;">
		<div class="d-flex flex-row justify-content-between align-items-center">
			<p class="text-white" style="font-size: 2rem; margin: 0;">Chat App</p>
			<div class="d-flex flex-row align-items-center">
				<span class="mx-4 text-white d-block">Hello, <b>{{user}}</b></span>
				<a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
			</div>
		</div>
	</div>
	<div class="container py-5 pt-1">
		<div class="row">
			<div class="col-md-12">
				<div class="card" id="chat3" style="border-radius: 15px">
					<div class="card-body">
						<div class="row">
							<div
								class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0"
							>
								<div class="p-3" style="border-right: 1px solid gray;">
									{% comment %} <div class="input-group rounded mb-3">
										<input
											type="search"
											class="form-control rounded"
											placeholder="Search"
											aria-label="Search"
											aria-describedby="search-addon"
										/>
										<span
											class="input-group-text border-0"
											id="search-addon"
										>
											<i class="fas fa-search"></i>
										</span>
									</div> {% endcomment %}

									<div class="mb-3" style="font-weight: bold; font-size: 1.5rem;">
										Users
									</div>

									<div
										data-mdb-perfect-scrollbar="true"
										style="
											position: relative;
											height: 400px;
											overflow: auto;
										"
									>
										<ul class="list-unstyled mb-0">
											{% for user in users %}
											{% include 'chat/user.html' with username=user %}
											{% endfor %}
										</ul>
									</div>
								</div>
							</div>

							{% if room_name %}
							<div class="col-md-6 col-lg-7 col-xl-8" style="position: relative">
								<div
									id="messages-container"
									class="pt-3 pe-3"
									data-mdb-perfect-scrollbar="true"
									style="
										position: relative;
										height: 400px;
										overflow: auto;
										scroll-behaviour: smooth;
									"
								>
									{% for message in messages %}
										{% is_sent message request as sent %}
										{% include 'chat/message.html' with sent=sent time=time message=message %} 
									{% endfor %}
								</div>

								{{ room_name|json_script:"room-name" }}

								<div
									class="text-muted d-flex justify-content-start align-items-center pe-3 pt-3 mt-2"
									style="
										position: absolute;
										bottom: 0;
										left: 0;
										width: 100%;
									"
								>
									<img
										src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava6-bg.webp"
										alt="avatar 3"
										style="width: 40px; height: 100%; margin-right: 4px;"
									/>
									<input
										type="text"
										class="form-control form-control-lg"
										id="chat-message-input"
										placeholder="Type message"
									/>
									<input id="chat-message-submit" type="button" value="Send" class="btn btn-primary" style="margin-left: 1rem;" />
									<a class="ms-1 text-muted" href="#!"
										><i class="fas fa-paperclip"></i
									></a>
									<a class="ms-3 text-muted" href="#!"
										><i class="fas fa-smile"></i
									></a>
									<a class="ms-3" href="#!"
										><i class="fas fa-paper-plane"></i
									></a>
								</div>
							</div>
							{% else %}
							<div class="col-md-6 col-lg-7 col-xl-8">
								<p style="text-align: center; margin-top: 10rem; font-weight: bold;">
									Select user to Chat with
								</p>
							</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>
{% endblock body %} 

{% block scripts %}
<script>
    const msgsContainer = document.querySelector("#messages-container");
    msgsContainer.scrollTop = msgsContainer.scrollHeight;

	const roomName = JSON.parse(
		document.getElementById("room-name").textContent
	);

	let protocal = "ws://";
	if (window.location.protocol === "https:") protocal = "wss://";

	function setupSocket() {
		if (roomName) {
			const chatSocket = new WebSocket(
				protocal + window.location.host + "/ws/chat/" + roomName + "/"
			);

			chatSocket.onmessage = function (e) {
				const data = JSON.parse(e.data);
				displayMessage(data.message)
			};
			
			chatSocket.onclose = function (e) {
				console.error("Chat socket closed unexpectedly, restarting...");
				setupSocket();
			};

			document.querySelector("#chat-message-input").focus();
			document.querySelector("#chat-message-input").onkeyup = function (e) {
				if (e.keyCode === 13) {
					// enter, return
					document.querySelector("#chat-message-submit").click();
				}
			};
			
			document.querySelector("#chat-message-submit").onclick = function (e) {
				const msgsContainer = document.querySelector("#messages-container");

				const messageInputDom = document.querySelector("#chat-message-input");
				const message = messageInputDom.value;
				
				checkProfanity(message).then((response) => {
					const isBad = response["is-bad"]
					const censoredContent = response["censored-content"]				
					
					const msgDom = constructMessage(censoredContent, true);
					msgsContainer.append(msgDom);
					msgsContainer.scrollTop = msgsContainer.scrollHeight
					
					if (isBad) {
						const badWords =  response["bad-words-list"].join("")
						alert(`Language like "${badWords}" is not allowed on this platform!`)
					}
					chatSocket.send(
						JSON.stringify({
							message: censoredContent,
						})
					);
					messageInputDom.value = "";
				}).catch(console.log);
			}; 
		}
	}
	
	setupSocket();
</script>
{% endblock scripts %}
